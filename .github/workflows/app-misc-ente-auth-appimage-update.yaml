name: app-misc/ente-auth-appimage Update

permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'  
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/app-misc-ente-auth-appimage-update.yaml'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: false

env:
  ecn: app-misc
  epn: ente-auth-appimage
  description: "Ente Auth AppImage"
  homepage: "https://ente.io/blog/auth/"
  github_owner: ente-io
  github_repo: ente

jobs:
  check-and-create-ebuild:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget jq coreutils

      - name: Check for new releases
        id: process_releases
        run: |
          ebuild_dir="./${ecn}/${epn}"
          mkdir -p $ebuild_dir
          
          tags=$(curl -s https://api.github.com/repos/${{ env.github_owner }}/${{ env.github_repo }}/releases | jq -r '.[].tag_name')
          release_tags=$(echo "tags" | grep "^auth-v")
          for tag in $release_tags; do
            version=${tag#auth-v}
            if ! echo "$version" | egrep '^([0-9]+)\.([0-9]+)(\.([0-9]+))?(-r[0-9]+)?((-|_)(alpha|beta|rc|p)[0-9]*)*$'; then
              echo "$tag / $version doesn't match regexp";
              continue; 
            fi
            ebuild_file="${ebuild_dir}/${epn}-${version}.ebuild"
            break
          done
